<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Management - IT Support Ticket System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="../css/styles.css" rel="stylesheet">
    <style>
        body {
            overflow-x: hidden;
            background-color: #f8f9fa;
        }

        #sidebar {
            min-width: 250px;
            max-width: 250px;
            min-height: 100vh;
            background: #343a40;
            color: #fff;
            transition: all 0.3s;
            box-shadow: 3px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        #sidebar .navbar-brand {
            padding: 20px 15px;
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        #sidebar .nav-link {
            padding: 15px;
            color: rgba(255, 255, 255, 0.75);
            border-left: 3px solid transparent;
            transition: all 0.2s;
            font-size: 1.05rem;
        }

        #sidebar .nav-link:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
        }

        #sidebar .nav-link.active {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
            border-left: 3px solid #0d6efd;
        }

        #sidebar .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        #content {
            width: 100%;
            min-height: 100vh;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
        }

        #user-dropdown {
            background: rgba(255, 255, 255, 0.05);
            margin-top: auto;
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .main-content {
            flex: 1;
            padding: 20px;
        }

        .dropdown-menu-dark {
            background-color: #2c3136;
            border: none;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }

        .dropdown-item {
            padding: 8px 15px;
            transition: all 0.2s;
        }

        .dropdown-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Status badge styles */
        .badge-open {
            background-color: #ffc107;
            color: #000;
        }

        .badge-in-progress {
            background-color: #17a2b8;
            color: #fff;
        }

        .badge-resolved {
            background-color: #28a745;
            color: #fff;
        }

        .badge-closed {
            background-color: #6c757d;
            color: #fff;
        }

        /* Priority badge styles */
        .badge-low {
            background-color: #28a745;
            color: #fff;
        }

        .badge-medium {
            background-color: #ffc107;
            color: #000;
        }

        .badge-high {
            background-color: #dc3545;
            color: #fff;
        }

        .comment-container {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .comment-user {
            font-weight: bold;
        }

        .comment-date {
            color: #6c757d;
        }

        .comment-text {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
        }

        .table .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
<div class="d-flex">
    <!-- Sidebar Navigation -->
    <div id="sidebar" class="d-flex flex-column">
        <a class="navbar-brand text-center border-bottom pb-3" href="/admin/dashboard">
            <i class="bi bi-shield-lock me-2"></i>Admin Panel
        </a>
        <ul class="nav flex-column mt-3">
            <li class="nav-item">
                <a class="nav-link" href="/admin/dashboard">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/users">
                    <i class="bi bi-people"></i> Users
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/admin/tickets">
                    <i class="bi bi-ticket-perforated"></i> Tickets
                </a>
            </li>
            <!--<li class="nav-item">
               <a class="nav-link" href="reports.html">
                   <i class="bi bi-graph-up"></i> Reports
               </a>
           </li>
           <li class="nav-item">
               <a class="nav-link" href="settings.html">
                   <i class="bi bi-gear"></i> Settings
               </a>
           </li>  -->
        </ul>

        <!-- User dropdown moved to bottom of sidebar -->
        <div class="mt-auto" id="user-dropdown">
            <div class="dropdown">
                <a class="nav-link dropdown-toggle text-white d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                    <i class="bi bi-person-circle me-2"></i>
                    <span id="username">Admin</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-dark w-100">
                    <!-- <li><a class="dropdown-item" href="profile.html"><i class="bi bi-person me-2"></i> Profile</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="../user/dashboard.html"><i class="bi bi-arrows-angle-contract me-2"></i> User View</a></li>  -->
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" id="logout-btn"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Page Content -->
    <div id="content">
        <!-- Main Content -->
        <div class="container-fluid py-4 main-content">
            <div class="row mb-4">
                <div class="col-md-6">
                    <h2><i class="bi bi-ticket-perforated me-2"></i>Ticket Management</h2>
                    <p class="text-muted">View, assign and manage support tickets</p>
                </div>
                <div class="col-md-6 text-end">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTicketModal">
                        <i class="bi bi-plus-circle me-1"></i> Create Ticket
                    </button>
                    <!-- <button type="button" class="btn btn-outline-primary ms-2">
                        <i class="bi bi-download me-1"></i> Export
                    </button> -->
                </div>
            </div>

            <!-- Filter and Search -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">Advanced Filters</h5>
                        </div>
                        <div class="card-body">
                            <form id="filter-form" method="get" action="/admin/tickets" class="row g-3">

                                <!-- Status Filter -->
                                <div class="col-md-2">
                                    <label for="status-filter" class="form-label">Status</label>
                                    <select class="form-select" id="status-filter" name="statusId">
                                        <option value="" th:selected="${selectedStatusId == null}">All Statuses</option>
                                        <option th:each="s : ${statuses}"
                                                th:value="${s.statusId}"
                                                th:text="${s.statusName}"
                                                th:selected="${selectedStatusId != null and selectedStatusId == s.statusId}">
                                        </option>
                                    </select>
                                </div>

                                <!-- Priority Filter -->
                                <div class="col-md-2">
                                    <label for="priority-filter" class="form-label">Priority</label>
                                    <select class="form-select" id="priority-filter" name="priorityId">
                                        <option value="" th:selected="${selectedPriorityId == null}">All Priorities</option>
                                        <option th:each="p : ${priorities}"
                                                th:value="${p.priorityId}"
                                                th:text="${p.priorityName}"
                                                th:selected="${selectedPriorityId != null and selectedPriorityId == p.priorityId}">
                                        </option>
                                    </select>
                                </div>

                                <!-- Type Filter -->
                                <div class="col-md-2">
                                    <label for="type-filter" class="form-label">Type</label>
                                    <select class="form-select" id="type-filter" name="typeId">
                                        <option value="" th:selected="${selectedTypeId == null}">All Types</option>
                                        <option th:each="t : ${types}"
                                                th:value="${t.typeId}"
                                                th:text="${t.typeName}"
                                                th:selected="${selectedTypeId != null and selectedTypeId == t.typeId}">
                                        </option>
                                    </select>
                                </div>

                                <!-- Assignee Filter -->
                                <div class="col-md-2">
                                    <label for="assignee-filter" class="form-label">Assignee</label>
                                    <select class="form-select" id="assignee-filter" name="assignedToId">
                                        <option value="" th:selected="${selectedAssignedToId == null}">All Assignees</option>
                                        <option value="0" th:selected="${selectedAssignedToId != null and selectedAssignedToId == 0}">Unassigned</option>
                                        <option th:each="technician : ${technicians}"
                                                th:value="${technician.id}"
                                                th:text="${technician.username}"
                                                th:selected="${selectedAssignedToId != null and selectedAssignedToId == technician.id}">
                                        </option>
                                    </select>
                                </div>

                                <!-- Date Range Filter -->
                                <div class="col-md-2">
                                    <label for="date-range" class="form-label">Date Range</label>
                                    <select class="form-select" id="date-range" name="dateRange">
                                        <option value="" th:selected="${selectedDateRange == null}">All Time</option>
                                        <option value="today" th:selected="${selectedDateRange == 'today'}">Today</option>
                                        <option value="week" th:selected="${selectedDateRange == 'week'}">This Week</option>
                                        <option value="month" th:selected="${selectedDateRange == 'month'}">This Month</option>
                                        <option value="custom" th:selected="${selectedDateRange == 'custom'}">Custom Range</option>
                                    </select>
                                </div>

                                <!-- Start Date (Custom Range) -->
                                <div class="col-md-2 custom-date-range" style="display: none;">
                                    <label for="start-date" class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="start-date" name="startDate" th:value="${selectedStartDate}">
                                </div>

                                <!-- End Date (Custom Range) -->
                                <div class="col-md-2 custom-date-range" style="display: none;">
                                    <label for="end-date" class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="end-date" name="endDate" th:value="${selectedEndDate}">
                                </div>

                                <!-- Search Field -->
                                <div class="col-md-2">
                                    <label for="search-tickets" class="form-label">Search</label>
                                    <input type="text" class="form-control" id="search-tickets" name="keyword"
                                           placeholder="Search tickets..." th:value="${selectedKeyword}">
                                </div>

                                <!-- Buttons -->
                                <div class="col-12 mt-3">
                                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                                    <button type="reset" id="clear-filters" class="btn btn-outline-secondary"
                                            onclick="window.location='/admin/tickets'; return false;">
                                        Clear Filters
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Tickets Table Section -->
            <div class="row">
                <div class="col-md-12">

                    <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
                    <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

                    <div class="card shadow-sm">

                        <!-- Card Body -->
                        <div class="card-body">


                            <!-- Responsive Table Container -->
                            <div class="table-responsive">

                                <!-- Tickets Table -->
                                <table class="table table-hover align-middle">

                                    <!-- Table Header -->
                                    <thead>
                                    <tr>
                                        <th style="width: 5%">ID</th>
                                        <th style="width: 25%">Title</th>
                                        <th style="width: 10%">Status</th>
                                        <th style="width: 10%">Priority</th>
                                        <th style="width: 10%">Created by</th>
                                        <th style="width: 10%">Assigned to</th>
                                        <th style="width: 12%">Created</th>
                                        <th style="width: 18%">Actions</th>
                                    </tr>
                                    </thead>

                                    <!-- Table Body -->
                                    <tbody id="tickets-list">
                                    <tr th:if="${#lists.isEmpty(tickets)}">
                                            <td colspan="8" class="text-center text-muted fw-bold py-4 px-3">
                                                <i class="bi bi-search"></i> No matching tickets found.
                                            </td>
                                    </tr>

                                    <!-- Ticket Row (Dynamic) -->
                                    <tr th:each="ticket : ${tickets}">
                                        <td th:text="${ticket.ticketId}"></td>
                                        <td th:text="${ticket.title}"></td>

                                        <!-- Badge de statut -->
                                        <td>
                                               <span th:switch="${ticket.status?.statusName}">
                                            <span th:case="'Open'" class="badge badge-open">Open</span>
                                            <span th:case="'In Progress'" class="badge badge-in-progress">In Progress</span>
                                            <span th:case="'Resolved'" class="badge badge-resolved">Resolved</span>
                                            <span th:case="'Closed'" class="badge badge-closed">Closed</span>
                                            <span th:case="*"
                                                  class="badge badge-secondary"
                                                  th:text="${ticket.status?.statusName} ?: 'Unknown'">
                                            </span>
                                        </span>

                                        </td>

                                        <!-- Badge de priorité -->
                                        <td>
                                        <span th:switch="${ticket.priority?.priorityName}">
                                        <span th:case="'High'" class="badge badge-high">High</span>
                                        <span th:case="'Medium'" class="badge badge-medium">Medium</span>
                                        <span th:case="'Low'" class="badge badge-low">Low</span>
                                        <span th:case="*"
                                              class="badge badge-secondary"
                                              th:text="${ticket.priority?.priorityName} ?: 'Unknown'">
                                        </span>
                                        </span>

                                        </td>

                                        <!-- Créé par -->
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar bg-primary me-2"
                                                     th:text="${(ticket.createdBy?.firstName != null && ticket.createdBy?.lastName != null) ? (ticket.createdBy.firstName.substring(0, 1).toUpperCase() + ticket.createdBy.lastName.substring(0, 1).toUpperCase()) : '?'}">
                                                </div>
                                                <span th:text="${(ticket.createdBy?.firstName != null && ticket.createdBy?.lastName != null) ? (ticket.createdBy.firstName + ' ' + ticket.createdBy.lastName) : 'Unknown'}"></span>
                                            </div>
                                        </td>

                                        <!-- Assigné à -->
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div th:if="${ticket.assignedTo != null}"
                                                     class="avatar bg-info me-2"
                                                     th:text="${(ticket.assignedTo.firstName != null && ticket.assignedTo.lastName != null) ? (ticket.assignedTo.firstName.substring(0, 1).toUpperCase() + ticket.assignedTo.lastName.substring(0, 1).toUpperCase()) : '?'}">
                                                </div>
                                                <span th:if="${ticket.assignedTo != null}"
                                                      th:text="${(ticket.assignedTo.firstName != null && ticket.assignedTo.lastName != null) ? (ticket.assignedTo.firstName + ' ' + ticket.assignedTo.lastName) : 'Unknown'}"></span>
                                                <span th:unless="${ticket.assignedTo != null}" class="text-danger"><i class="bi bi-exclamation-triangle-fill me-1"></i> Unassigned</span>
                                            </div>
                                        </td>

                                        <!-- Date de création -->
                                        <td th:text="${#temporals.format(ticket.createdAt, 'dd MMM yyyy, hh:mm a')}"></td>

                                        <!-- Actions -->
                                        <td>
                                            <button class="btn btn-sm btn-primary"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#assignTicketModal"
                                                    th:attr="data-ticket-id=${ticket.ticketId}">
                                                <i class="bi bi-person-plus"></i> Assign
                                            </button>


                                            <!-- <button class="btn btn-sm btn-info"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#ticketDetailsModal"
                                                    th:attr="data-ticket-id=${ticket.ticketId}">
                                                <i class="bi bi-eye"></i> View
                                            </button> -->

                                            <div class="dropdown d-inline-block">
                                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                                                        type="button"
                                                        data-bs-toggle="dropdown">
                                                    <i class="bi bi-three-dots"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li>
                                                        <a class="dropdown-item" th:href="@{'/tickets/edit/' + ${ticket.ticketId}}">
                                                            <i class="bi bi-pencil me-2"></i> Edit
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item text-danger"
                                                           th:href="@{'/tickets/delete/' + ${ticket.ticketId}}"
                                                           onclick="return confirm('Are you sure you want to delete this ticket?');">
                                                            <i class="bi bi-trash me-2"></i> Delete
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination -->
                            <nav aria-label="Tickets pagination" class="mt-4">
                                <ul class="pagination justify-content-center" id="pagination">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                                    </li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                                    <li class="page-item">
                                        <a class="page-link" href="#">Next</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer mt-auto py-3 bg-light">
            <div class="container text-center">
                <span class="text-muted">IT Support Ticket System &copy; 2025</span>
            </div>
        </footer>
    </div>
</div>

<!-- Create Ticket Modal -->
<div class="modal fade" id="createTicketModal" tabindex="-1" aria-labelledby="createTicketModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createTicketModalLabel">Create New Ticket</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="create-ticket-form">
                    <div class="mb-3">
                        <label for="ticket-user" class="form-label">Create Ticket For</label>
                        <select class="form-select" id="ticket-user" name="createdById" required>
                            <option value="">Select User</option>
                            <th:block th:each="user : ${users}">
                                <option th:value="${user.id}"
                                        th:text="${user.firstName} + ' ' + ${user.lastName}"></option>
                            </th:block>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="ticket-title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="ticket-title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="ticket-description" class="form-label">Description</label>
                        <textarea class="form-control" id="ticket-description" name="description" rows="4" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="ticket-type" class="form-label">Type</label>
                            <select class="form-select" id="ticket-type" name="typeId" required>
                                <option value="">Select Type</option>
                                <th:block th:each="t : ${types}">
                                    <option th:value="${t.typeId}" th:text="${t.typeName}"></option>
                                </th:block>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="ticket-priority" class="form-label">Priority</label>
                            <select class="form-select" id="ticket-priority" name="priorityId" required>
                                <option value="">Select Priority</option>
                                <th:block th:each="p : ${priorities}">
                                    <option th:value="${p.priorityId}" th:text="${p.priorityName}"></option>
                                </th:block>
                            </select>

                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="ticket-assign" class="form-label">Assign To</label>
                            <select class="form-select" id="ticket-assign" name="assignedToUserId">
                                <option value="">Unassigned</option>
                                <th:block th:each="tech : ${technicians}">
                                    <option th:value="${tech.id}"
                                            th:text="${tech.firstName} + ' ' + ${tech.lastName}"></option>
                                </th:block>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submit-ticket">Create Ticket</button>
            </div>
        </div>
    </div>
</div>

<!-- ========================================================================= -->
<!-- EDIT TICKET MODAL -->
<!-- ========================================================================= -->
<div th:if="${ticketToEdit}" class="modal fade" id="editTicketModal" tabindex="-1" aria-labelledby="editTicketModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!-- Use th:object to bind the form to the ticketToEdit object -->
            <form th:action="@{/tickets/edit}" th:object="${ticketToEdit}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="editTicketModalLabel">Edit Ticket #<span th:text="*{ticketId}"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Hidden input to send the ticket ID -->
                    <input type="hidden" th:field="*{ticketId}" />
                    <!-- CreatedBy and CreatedAt are not editable but good to show -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Created By:</strong>
                            <span th:text="*{createdBy?.firstName + ' ' + createdBy?.lastName}">User</span>
                        </div>
                        <div class="col-md-6">
                            <strong>Created At:</strong>
                            <span th:text="${#temporals.format(ticketToEdit.createdAt, 'dd MMM yyyy, hh:mm a')}">Date</span>
                        </div>
                    </div>


                    <div class="mb-3">
                        <label for="edit-ticket-title" class="form-label">Title</label>
                        <!-- Use th:field to bind the input to the object's property -->
                        <input type="text" class="form-control" id="edit-ticket-title" th:field="*{title}" required>
                    </div>

                    <div class="mb-3">
                        <label for="edit-ticket-description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit-ticket-description" rows="4" th:field="*{description}" required></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="edit-ticket-status" class="form-label">Status</label>
                            <select class="form-select" id="edit-ticket-status" th:field="*{status.statusId}" required>
                                <option th:each="s : ${statuses}"
                                        th:value="${s.statusId}"
                                        th:text="${s.statusName}"></option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="edit-ticket-priority" class="form-label">Priority</label>
                            <select class="form-select" id="edit-ticket-priority" th:field="*{priority.priorityId}" required>
                                <option th:each="p : ${priorities}"
                                        th:value="${p.priorityId}"
                                        th:text="${p.priorityName}"></option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="edit-ticket-type" class="form-label">Type</label>
                            <select class="form-select" id="edit-ticket-type" th:field="*{type.typeId}" required>
                                <option th:each="t : ${types}"
                                        th:value="${t.typeId}"
                                        th:text="${t.typeName}"></option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="edit-ticket-assign" class="form-label">Assign To</label>
                            <select class="form-select" id="edit-ticket-assign" th:field="*{assignedTo.id}">
                                <option value="">Unassigned</option>
                                <option th:each="tech : ${technicians}"
                                        th:value="${tech.id}"
                                        th:text="${tech.firstName + ' ' + tech.lastName}"></option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Assign Ticket Modal  -->
<div class="modal fade" id="assignTicketModal" tabindex="-1" aria-labelledby="assignTicketModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Formulaire classique qui sera soumis. th:action est correct. -->
            <form id="assign-ticket-form" method="post" th:action="@{/tickets/assign-form}">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignTicketModalLabel">Assign Ticket #<span id="assign-ticket-id-display"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Champ caché simple. Il a un 'id' pour être trouvé par JS et un 'name' pour être soumis. -->
                    <input type="hidden" id="ticket-id-to-assign" name="ticketId" />

                    <div class="mb-3">
                        <label for="technician-select" class="form-label">Select Technician</label>
                        <select class="form-select" id="technician-select" name="technicianId" required>
                            <option value="">Choose a technician...</option>
                            <!-- Thymeleaf remplit les options, c'est parfait. -->
                            <option th:each="tech : ${technicians}"
                                    th:value="${tech.id}"
                                    th:text="${tech.firstName} + ' ' + ${tech.lastName}"></option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="assignment-note" class="form-label">Assignment Note (optional)</label>
                        <textarea class="form-control" id="assignment-note" name="assignmentNote" rows="3"></textarea>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="notify-technician" name="notifyTechnician" value="true" checked />
                        <label class="form-check-label" for="notify-technician">Send email notification</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign Ticket</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Ticket Details Modal -->
<div class="modal fade" id="ticketDetailsModal" tabindex="-1" aria-labelledby="ticketDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ticketDetailsModalLabel">Ticket #<span id="detail-ticket-id">1001</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <!-- Ticket Information -->
                        <h4 id="detail-ticket-title">Unable to access email account</h4>
                        <div class="mb-3 mt-3">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <span class="badge badge-open" id="detail-ticket-status">Open</span>
                                    <span class="badge badge-high" id="detail-ticket-priority">High</span>
                                    <span class="badge bg-secondary" id="detail-ticket-type">Incident</span>
                                </div>
                                <div>
                                    Created: <span id="detail-ticket-created">23 Mar 2025, 10:15 AM</span>
                                </div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <h5>Description</h5>
                            <p id="detail-ticket-description">I cannot access my email account since this morning. I've tried restarting my computer and resetting my password, but I still get an "invalid credentials" error message. This is impacting my ability to communicate with clients.</p>
                        </div>

                        <!-- Comments Section -->
                        <div class="card mb-3 shadow-sm">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Comments</h5>
                                <span class="badge bg-primary rounded-pill">3</span>
                            </div>
                            <div class="card-body">
                                <div id="comments-list">
                                    <!-- Comments examples -->
                                    <div class="comment-container">
                                        <div class="comment-header">
                                            <div class="comment-user">
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar bg-primary me-2" style="width: 24px; height: 24px; font-size: 0.7rem;">JD</div>
                                                    John Doe
                                                </div>
                                            </div>
                                            <div class="comment-date">23 Mar 2025, 10:15 AM</div>
                                        </div>
                                        <div class="comment-text">
                                            I have tried clearing my browser cache as well, but still no success.
                                        </div>
                                    </div>

                                    <div class="comment-container">
                                        <div class="comment-header">
                                            <div class="comment-user">
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar bg-info me-2" style="width: 24px; height: 24px; font-size: 0.7rem;">TJ</div>
                                                    Tom Johnson (Technician)
                                                </div>
                                            </div>
                                            <div class="comment-date">23 Mar 2025, 10:45 AM</div>
                                        </div>
                                        <div class="comment-text">
                                            I'll look into this right away. Could you confirm which email client you're using (Outlook, web browser, etc.)?
                                        </div>
                                    </div>

                                    <div class="comment-container">
                                        <div class="comment-header">
                                            <div class="comment-user">
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar bg-primary me-2" style="width: 24px; height: 24px; font-size: 0.7rem;">JD</div>
                                                    John Doe
                                                </div>
                                            </div>
                                            <div class="comment-date">23 Mar 2025, 11:05 AM</div>
                                        </div>
                                        <div class="comment-text">
                                            I'm using Outlook 365 desktop application. Version 2302.
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <form id="add-comment-form">
                                        <div class="mb-3">
                                            <label for="comment-text" class="form-label">Add Comment</label>
                                            <textarea class="form-control" id="comment-text" rows="3" required></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Post Comment</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Ticket Details Sidebar -->
                        <div class="card shadow-sm">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">Ticket Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <p class="mb-2"><strong>Created by:</strong></p>
                                    <div class="d-flex align-items-center" id="detail-created-by">
                                        <div class="avatar bg-primary me-2">JD</div>
                                        <span>John Doe</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <p class="mb-2"><strong>Assigned to:</strong></p>
                                    <div class="d-flex align-items-center" id="detail-assigned-to">
                                        <span class="text-danger"><i class="bi bi-exclamation-triangle-fill me-1"></i>Unassigned</span>
                                    </div>
                                </div>
                                <p><strong>Last updated:</strong> <span id="detail-updated-at">23 Mar 2025, 11:05 AM</span></p>

                                <!-- Ticket Management Actions -->
                                <hr>
                                <h6>Ticket Actions</h6>
                                <div class="mb-3">
                                    <label for="update-status" class="form-label">Update Status</label>
                                    <select class="form-select" id="update-status">
                                        <option value="1" selected>Open</option>
                                        <option value="2">In Progress</option>
                                        <option value="3">Resolved</option>
                                        <option value="4">Closed</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="update-priority" class="form-label">Update Priority</label>
                                    <select class="form-select" id="update-priority">
                                        <option value="1">Low</option>
                                        <option value="2">Medium</option>
                                        <option value="3" selected>High</option>
                                    </select>
                                </div>
                                <div class="mb-3 d-grid">
                                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#assignTicketModal" data-ticket-id="1001">
                                        <i class="bi bi-person-plus me-1"></i> Assign Ticket
                                    </button>
                                </div>
                                <div class="mb-3 d-grid">
                                    <button type="button" class="btn btn-success" id="update-ticket-btn">
                                        <i class="bi bi-save me-1"></i> Update Ticket
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Ticket History -->
                        <div class="card mt-3 shadow-sm">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">Ticket History</h5>
                            </div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush" id="ticket-history">
                                    <li class="list-group-item px-0 border-0">
                                        <p class="mb-1 fw-bold">Status changed to "Open"</p>
                                        <small class="text-muted">By System • 23 Mar 2025, 10:15 AM</small>
                                    </li>
                                    <li class="list-group-item px-0 border-0">
                                        <p class="mb-1 fw-bold">Ticket created</p>
                                        <small class="text-muted">By John Doe • 23 Mar 2025, 10:15 AM</small>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    // Simple script to populate ticket ID for assignment modal
    document.addEventListener('DOMContentLoaded', function() {
        // For assign ticket modal
        const assignTicketModal = document.getElementById('assignTicketModal');
        if (assignTicketModal) {
            assignTicketModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const ticketId = button.getAttribute('data-ticket-id');
                document.getElementById('assign-ticket-id').textContent = ticketId;
                document.getElementById('ticket-id-to-assign').value = ticketId;
            });
        }

        // Simulate ticket assignment
        const confirmAssignmentBtn = document.getElementById('confirm-assignment');
        if (confirmAssignmentBtn) {
            confirmAssignmentBtn.addEventListener('click', function() {
                const ticketId = document.getElementById('ticket-id-to-assign').value;
                const technicianId = document.getElementById('technician-select').value;
                const technicianName = document.getElementById('technician-select').options[document.getElementById('technician-select').selectedIndex].text.split(' (')[0];

                if (!technicianId) {
                    alert('Please select a technician');
                    return;
                }

                // Here you would normally make an API call to update the ticket
                alert(`Ticket #${ticketId} has been assigned to ${technicianName}`);

                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('assignTicketModal'));
                modal.hide();

                // In a real app, you would refresh the ticket list or update the DOM
            });
        }
    });

//create ticket and it works
document.getElementById("submit-ticket").addEventListener("click", function () {
    const form = document.getElementById("create-ticket-form");
    const formData = new FormData(form);

    fetch("/admin/tickets/create", {
        method: "POST",
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams(formData)
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        } else if (response.ok) {
            // Success without redirect
            alert("Ticket created successfully!");
        } else {
            alert("Ticket creation failed.");
        }
    })
    .catch(error => {
        console.error("Error creating ticket:", error);
        alert("An error occurred.");
    });
});

//JavaScript to toggle date fields
document.addEventListener('DOMContentLoaded', function () {
                    const dateRangeSelect = document.getElementById('date-range');
                    const customDateFields = document.querySelectorAll('.custom-date-range');

                    function toggleCustomDateFields() {
                        if (dateRangeSelect.value === 'custom') {
                            customDateFields.forEach(el => el.style.display = 'block');
                        } else {
                            customDateFields.forEach(el => el.style.display = 'none');
                        }
                    }

                    // Initial state
                    toggleCustomDateFields();

                    // On change
                    dateRangeSelect.addEventListener('change', toggleCustomDateFields);
                });

//edit form for assigment
 document.addEventListener('DOMContentLoaded', function() {

        // --- Logique pour le modal d'assignation (Event-Driven) ---
        // Cette partie s'exécute uniquement lorsqu'un modal d'assignation est ouvert.
        const assignModalElement = document.getElementById('assignTicketModal');
        if (assignModalElement) {
            assignModalElement.addEventListener('show.bs.modal', function(event) {
                // Le bouton qui a déclenché le modal
                const button = event.relatedTarget;
                if (!button) return; // Sécurité si le modal est ouvert sans bouton

                // Lire l'ID du ticket depuis l'attribut data-* du bouton
                const ticketId = button.getAttribute('data-ticket-id');

                // Trouver les éléments à mettre à jour à l'intérieur du modal
                const ticketIdInput = assignModalElement.querySelector('#ticket-id-to-assign');
                const ticketIdDisplay = assignModalElement.querySelector('#assign-ticket-id-display');

                // Mettre à jour les valeurs (l'étape qui résout votre problème)
                if (ticketIdInput && ticketIdDisplay) {
                    ticketIdInput.value = ticketId;
                    ticketIdDisplay.textContent = ticketId;
                }
            });
        }

        // --- Logique pour le modal d'édition (Conditionnelle) ---
        // Cette partie ne s'exécute que si Thymeleaf a rendu le modal d'édition.
        // On récupère la variable passée par le serveur. Si elle n'existe pas, la variable sera 'null'.
        const ticketToEdit = /*[[${ticketToEdit}]]*/ null;

        // La condition 'if(ticketToEdit)' est la clé qui évite le conflit.
        // Ce code ne s'exécutera QUE sur la page rechargée après un clic sur "Edit".
        if(ticketToEdit) {
            const editModalElement = document.getElementById('editTicketModal');
            if(editModalElement) {
                // On crée une nouvelle instance de l'objet Modal de Bootstrap et on l'affiche.
                const editModal = new bootstrap.Modal(editModalElement);
                editModal.show();
            }
        }

        // Vous pouvez ajouter ici la logique pour vos autres modals (Create, Details, etc.)
        // en suivant le même modèle : if (document.getElementById('...')) { ... }

    });

</script>
<script>
    document.getElementById('logout-btn').addEventListener('click', function(event) {
        event.preventDefault();
        if (confirm("Are you sure you want to log out?")) {
            window.location.href = "/logout";
        }
    });
</script>
</body>
</html>